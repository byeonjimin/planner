<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주간 시간표 플래너</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .week-grid {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            /* FIX: 각 칸의 세로 길이를 100px로 늘렸습니다. */
            grid-template-rows: 40px repeat(24, 100px);
        }
        .time-label {
            grid-column: 1;
        }
        .day-header {
            grid-row: 1;
        }
        .planner-cell {
            /* FIX: 최소 높이도 100px로 맞췄습니다. */
            min-height: 100px;
            font-size: 12px;
            overflow-y: auto;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }
        .dark .planner-cell {
            border-color: #374151;
        }
        .planner-cell:hover {
            background-color: #f0f9ff;
        }
        .dark .planner-cell:hover {
            background-color: #1e293b;
        }
        
        /* Modal */
        #edit-modal-backdrop {
            transition: opacity 0.3s ease;
        }
        #edit-modal-panel {
            transition: all 0.3s ease;
        }

        /* contenteditable 플레이스홀더 */
        [contenteditable]:empty:before {
            content: attr(placeholder);
            pointer-events: none;
            display: block;
            color: #9ca3af;
            font-weight: 400;
        }
        /* 입력된 텍스트 스타일 */
        #modal-task-input {
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .preset-color.selected {
            box-shadow: 0 0 0 3px #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="app" class="container mx-auto p-4 max-w-7xl">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-800 dark:text-white">주간 시간표 플래너</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2">한 주를 한눈에 계획하고 관리하세요.</p>
            <div id="user-info" class="mt-3 text-sm text-gray-600 dark:text-gray-300"></div>
        </header>

        <!-- 주간 네비게이션 -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 mb-6 flex items-center justify-between gap-4">
            <button id="prev-week" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">이전 주</button>
            <h2 id="week-range" class="text-lg font-bold text-center"></h2>
            <button id="next-week" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">다음 주</button>
        </div>

        <main id="timetable-container" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-x-auto">
            <div id="timetable" class="week-grid">
                <!-- 주간 시간표가 여기에 동적으로 생성됩니다. -->
            </div>
        </main>
        
        <footer class="text-center mt-8 text-gray-500 dark:text-gray-400 text-sm">
            <p>&copy; 2025 Your Daily Planner. All rights reserved.</p>
        </footer>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden">
        <div id="edit-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div id="edit-modal-panel" class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 transform scale-95 opacity-0">
                <h3 id="modal-title" class="text-xl font-bold mb-4">계획 수정</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">계획 내용</label>
                        <div id="modal-task-input" contenteditable="true" placeholder="무엇을 할 계획인가요?" class="w-full min-h-[80px] p-3 border border-gray-300 dark:border-gray-600 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">색상 선택</label>
                        <div id="preset-colors" class="flex flex-wrap gap-2 mb-2">
                           <button class="preset-color w-8 h-8 rounded-full border border-gray-200" data-color="#ffffff" style="background-color: #ffffff;"></button>
                           <button class="preset-color w-8 h-8 rounded-full border border-gray-200" data-color="#ffadad" style="background-color: #ffadad;"></button>
                           <button class="preset-color w-8 h-8 rounded-full border border-gray-200" data-color="#ffd6a5" style="background-color: #ffd6a5;"></button>
                           <button class="preset-color w-8 h-8 rounded-full border border-gray-200" data-color="#fdffb6" style="background-color: #fdffb6;"></button>
                           <button class="preset-color w-8 h-8 rounded-full border border-gray-200" data-color="#caffbf" style="background-color: #caffbf;"></button>
                           <button class="preset-color w-8 h-8 rounded-full border border-gray-200" data-color="#9bf6ff" style="background-color: #9bf6ff;"></button>
                           <button class="preset-color w-8 h-8 rounded-full border border-gray-200" data-color="#a0c4ff" style="background-color: #a0c4ff;"></button>
                           <button class="preset-color w-8 h-8 rounded-full border border-gray-200" data-color="#bdb2ff" style="background-color: #bdb2ff;"></button>
                        </div>
                        <input type="color" id="modal-color-input" class="w-full h-10 p-0 border-none rounded-lg cursor-pointer bg-transparent">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="modal-cancel-button" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">취소</button>
                    <button id="modal-save-button" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO_KEY", authDomain: "DEMO.firebaseapp.com", projectId: "DEMO" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'daily-planner';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let currentDate = new Date();
        let weekData = {};

        const timetable = document.getElementById('timetable');
        const weekRangeEl = document.getElementById('week-range');
        const prevWeekBtn = document.getElementById('prev-week');
        const nextWeekBtn = document.getElementById('next-week');
        const userInfoElement = document.getElementById('user-info');

        const modal = document.getElementById('edit-modal');
        const modalBackdrop = document.getElementById('edit-modal-backdrop');
        const modalPanel = document.getElementById('edit-modal-panel');
        const modalTitle = document.getElementById('modal-title');
        const modalTaskInput = document.getElementById('modal-task-input');
        const modalColorInput = document.getElementById('modal-color-input');
        const modalSaveButton = document.getElementById('modal-save-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');
        const presetColorsContainer = document.getElementById('preset-colors');
        let currentEditingCell = null;

        function getTextColorForBg(hexColor) {
            if (!hexColor) return '#111827';
            const hex = hexColor.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b);
            return luminance > 186 ? '#111827' : '#f9fafb';
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getWeekInfo(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            const weekStart = new Date(d.setDate(diff));
            const week = [];
            for (let i = 0; i < 7; i++) {
                const dayInWeek = new Date(weekStart);
                dayInWeek.setDate(weekStart.getDate() + i);
                week.push(dayInWeek);
            }
            return week;
        }
        
        async function loadWeekData() {
            if (!userId) {
                renderWeekView(); // 로그인 안돼도 일단 틀은 보여주기
                return;
            };
            const week = getWeekInfo(currentDate);
            weekRangeEl.textContent = `${formatDate(week[0])} ~ ${formatDate(week[6])}`;
            
            const promises = week.map(day => {
                const formattedDate = formatDate(day);
                const dbRef = doc(db, 'artifacts', appId, 'users', userId, 'schedules', formattedDate);
                return getDoc(dbRef);
            });

            const results = await Promise.all(promises);
            weekData = {};
            results.forEach((docSnap, index) => {
                const formattedDate = formatDate(week[index]);
                if (docSnap.exists()) {
                    weekData[formattedDate] = docSnap.data().schedule || {};
                }
            });
            renderWeekView();
        }

        function renderWeekView() {
            timetable.innerHTML = '';
            const week = getWeekInfo(currentDate);
            const daysOfWeek = ['일', '월', '화', '수', '목', '금', '토'];

            timetable.appendChild(document.createElement('div'));

            daysOfWeek.forEach((day, index) => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header font-bold text-sm border-b-2 border-gray-300 dark:border-gray-600 p-2 text-right';
                dayHeader.textContent = `${day} (${week[index].getDate()})`;
                if (week[index].getDay() === 0) dayHeader.classList.add('text-red-500');
                if (week[index].getDay() === 6) dayHeader.classList.add('text-blue-500');
                timetable.appendChild(dayHeader);
            });

            for (let hour = 0; hour < 24; hour++) {
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label flex items-center justify-center text-xs text-gray-500 border-r border-b dark:border-gray-700';
                timeLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
                timetable.appendChild(timeLabel);

                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const cell = document.createElement('div');
                    const formattedDate = formatDate(week[dayIndex]);
                    const hourStr = hour.toString().padStart(2, '0');
                    cell.id = `cell-${formattedDate}-${hourStr}`;
                    cell.className = 'planner-cell p-2 cursor-pointer'; 
                    cell.dataset.date = formattedDate;
                    cell.dataset.hour = hourStr;

                    const daySchedule = weekData[formattedDate];
                    if (daySchedule && daySchedule[hourStr]) {
                        const { task, color } = daySchedule[hourStr];
                        cell.textContent = task;
                        cell.style.backgroundColor = color;
                        cell.style.color = getTextColorForBg(color);
                    }
                    
                    cell.addEventListener('click', () => openEditModal(cell));
                    timetable.appendChild(cell);
                }
            }
        }

        function updateSelectedPreset(color) {
            const buttons = presetColorsContainer.querySelectorAll('.preset-color');
            buttons.forEach(button => {
                button.classList.toggle('selected', button.dataset.color.toLowerCase() === color.toLowerCase());
            });
        }

        function openEditModal(cell) {
            currentEditingCell = cell;
            const { date, hour } = cell.dataset;
            const daySchedule = weekData[date];
            const data = (daySchedule && daySchedule[hour]) ? daySchedule[hour] : { task: '', color: '#ffffff' };

            modalTitle.textContent = `${date} ${hour}:00 계획 수정`;
            modalTaskInput.innerText = data.task;
            modalColorInput.value = data.color;
            modalTaskInput.style.backgroundColor = data.color;
            modalTaskInput.style.color = getTextColorForBg(data.color);
            updateSelectedPreset(data.color);

            modal.classList.remove('hidden');
            modalBackdrop.classList.remove('opacity-0');
            modalPanel.classList.remove('scale-95', 'opacity-0');
        }

        function closeModal() {
            currentEditingCell = null;
            modalBackdrop.classList.add('opacity-0');
            modalPanel.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function saveSchedule() {
            if (!currentEditingCell) return;
            
            if (!userId) {
                alert("로그인 정보가 없어 저장할 수 없습니다. 이 내용은 새로고침하면 사라집니다.");
                closeModal();
                return;
            }
            
            const { date, hour } = currentEditingCell.dataset;
            const task = modalTaskInput.innerText;
            const color = modalColorInput.value;

            const dbRef = doc(db, 'artifacts', appId, 'users', userId, 'schedules', date);
            
            currentEditingCell.innerText = task;
            currentEditingCell.style.backgroundColor = color;
            currentEditingCell.style.color = getTextColorForBg(color);
            
            closeModal();

            try {
                // FIX: 데이터를 덮어쓰지 않고 특정 시간만 업데이트하도록 merge: true 옵션을 사용합니다.
                await setDoc(dbRef, {
                    schedule: {
                        [hour]: { task, color }
                    }
                }, { merge: true });
            } catch (error) {
                console.error("저장 중 오류 발생:", error);
            }
        }

        function handleWeekChange(weeks) {
            currentDate.setDate(currentDate.getDate() + (weeks * 7));
            if(userId) {
                loadWeekData();
            } else {
                const week = getWeekInfo(currentDate);
                weekRangeEl.textContent = `${formatDate(week[0])} ~ ${formatDate(week[6])}`;
                renderWeekView();
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userInfoElement.textContent = `사용자 ID: ${userId}`;
                loadWeekData();
            } else {
                userId = null;
                userInfoElement.textContent = '로그인되지 않았습니다. (저장 불가)';
            }
        });

        async function main() {
            renderWeekView();

            prevWeekBtn.addEventListener('click', () => handleWeekChange(-1));
            nextWeekBtn.addEventListener('click', () => handleWeekChange(1));
            modalSaveButton.addEventListener('click', saveSchedule);
            modalCancelButton.addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', closeModal);

            presetColorsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('preset-color')) {
                    const color = e.target.dataset.color;
                    modalColorInput.value = color;
                    modalTaskInput.style.backgroundColor = color;
                    modalTaskInput.style.color = getTextColorForBg(color);
                    updateSelectedPreset(color);
                }
            });

            modalColorInput.addEventListener('input', (e) => {
                const color = e.target.value;
                modalTaskInput.style.backgroundColor = color;
                modalTaskInput.style.color = getTextColorForBg(color);
                updateSelectedPreset(color);
            });

            modalTaskInput.addEventListener('input', (e) => {
                if (e.target.innerText.trim() === '') {
                    e.target.innerHTML = '';
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("로그인 중 오류 발생:", error);
                userInfoElement.textContent = '로그인에 실패했습니다.';
            }
        }

        main();
    </script>
</body>
</html>
